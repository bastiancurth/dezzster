<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Deezster 3.0 - Ultimate Edition</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- PREMIUM DESIGN --- */
        :root {
            --primary: #23a6d5;
            --secondary: #e73c7e;
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: 1px solid rgba(255, 255, 255, 0.2);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
            --font-main: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: var(--font-main); -webkit-tap-highlight-color: transparent; }

        body {
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%; animation: gradientBG 15s ease infinite;
            color: white; min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 10px;
        }
        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        .app-container {
            width: 100%; max-width: 600px;
            background: var(--glass-bg); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            border: var(--glass-border); border-radius: 24px; box-shadow: var(--glass-shadow);
            padding: 20px; text-align: center; position: relative; overflow: hidden;
            display: flex; flex-direction: column; max-height: 95vh; transition: all 0.3s;
        }

        /* TYPOGRAPHY */
        h1 { font-size: 2rem; font-weight: 800; text-shadow: 0 0 10px rgba(0,0,0,0.2); margin-bottom: 5px; }
        h1 span { text-shadow: 0 0 15px var(--primary); }
        h3 { margin-bottom: 15px; opacity: 0.9; }
        p { font-size: 0.95rem; opacity: 0.9; margin-bottom: 10px; }

        /* UI ELEMENTS */
        input {
            width: 100%; padding: 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.3);
            background: rgba(0,0,0,0.2); color: white; font-size: 1rem; margin-bottom: 10px; outline: none; text-align: center;
        }
        .btn {
            width: 100%; padding: 14px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.2);
            font-size: 1rem; font-weight: 700; cursor: pointer; transition: all 0.1s;
            display: inline-flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 8px;
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .btn:active { transform: scale(0.97); }
        .btn-primary { background: rgba(255, 255, 255, 0.25); color: white; }
        .btn-secondary { background: rgba(0, 0, 0, 0.3); color: white; }
        .btn-success { background: #2ecc71; border-color: #27ae60; }
        .btn-danger { background: #e74c3c; border-color: #c0392b; }
        .btn-warn { background: #f39c12; border-color: #d35400; }

        /* MENU GRID */
        .mode-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .mode-card {
            background: rgba(255,255,255,0.15); padding: 15px 10px; border-radius: 12px; cursor: pointer;
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px;
            transition: background 0.2s; border: 1px solid transparent;
        }
        .mode-card:hover { background: rgba(255,255,255,0.25); border-color: white; }
        .mode-card i { font-size: 1.5rem; margin-bottom: 5px; }
        .mode-card span { font-size: 0.8rem; font-weight: bold; }
        .mode-desc { font-size: 0.7rem; opacity: 0.7; font-weight: normal; }

        /* VINYL & PLAYER */
        .vinyl-wrapper-sm { width: 100px; height: 100px; margin: 10px auto; position: relative; flex-shrink: 0; }
        .vinyl {
            width: 100%; height: 100%; background: radial-gradient(#333, #111);
            border-radius: 50%; border: 3px solid #111; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        .vinyl-label { width: 40%; height: 40%; background: var(--primary); border-radius: 50%; border: 2px solid white; background-size: cover; transition: filter 0.3s; }
        .spinning { animation: spin 4s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* TIMELINE SPECIFIC */
        .timeline-container {
            display: flex; flex-direction: column; gap: 8px; overflow-y: auto; max-height: 50vh; padding: 5px;
            background: rgba(0,0,0,0.15); border-radius: 12px; margin-top: 10px;
        }
        .timeline-card {
            background: white; color: black; padding: 10px; border-radius: 8px;
            display: flex; align-items: center; gap: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .insert-btn {
            background: rgba(255,255,255,0.15); border: 2px dashed rgba(255,255,255,0.3);
            color: white; padding: 10px; border-radius: 8px; cursor: pointer; font-size: 0.8rem; font-weight: bold;
        }

        /* 1-SECOND & BLUR SPECIFIC */
        .blur-container { width: 200px; height: 200px; margin: 20px auto; overflow: hidden; border-radius: 15px; box-shadow: 0 10px 20px rgba(0,0,0,0.5); }
        .blur-img { width: 100%; height: 100%; object-fit: cover; filter: blur(30px); transform: scale(1.1); }
        .unblur-anim { animation: unblur 20s linear forwards; }
        @keyframes unblur { to { filter: blur(0px); } }

        /* UTILITY */
        .hidden { display: none !important; }
        .modal-overlay {
            position: absolute; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.95);
            display: flex; align-items: center; justify-content: center; z-index: 50; flex-direction: column;
        }
        .spinner { border: 3px solid rgba(255,255,255,0.1); border-top: 3px solid #fff; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto 10px; }
        .score-float { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 4rem; font-weight: 900; color: #2ecc71; text-shadow: 0 5px 20px black; animation: floatUp 1s forwards; pointer-events: none; z-index: 100; }
        @keyframes floatUp { to { transform: translate(-50%, -150%); opacity: 0; } }

        .timer-bar { width: 100%; height: 6px; background: rgba(255,255,255,0.2); margin: 10px 0; border-radius: 3px; overflow: hidden; }
        .timer-fill { height: 100%; width: 100%; background: #2ecc71; transform-origin: left; }
        .timer-anim { animation: timerShrink linear forwards; }
        @keyframes timerShrink { 0% { transform: scaleX(1); background: #2ecc71; } 50% { background: #f1c40f; } 100% { transform: scaleX(0); background: #e74c3c; } }

    </style>
</head>
<body>

    <div class="app-container">
        <header>
            <h1>Deez<span>ster</span></h1>
        </header>

        <div id="screen-search">
            <p>W√§hle eine Playlist:</p>
            <input type="text" id="search-input" placeholder="Suche (z.B. 90s, Rock, Disney)...">
            <button class="btn btn-primary" onclick="searchPlaylists()">Suchen</button>
            <div id="playlist-list">
                <div class="playlist-item" onclick="selectPlaylist('3155776842', '100% Hits')">
                    <img src="https://e-cdns-images.dzcdn.net/images/playlist/89f6dfc009b0b43d2c0024440f340864/250x250-000000-80-0-0.jpg">
                    <div class="playlist-info"><h4>100% Hits</h4><span>Mix</span></div>
                </div>
            </div>
        </div>

        <div id="screen-mode" class="hidden">
            <h3 id="selected-playlist-name" style="color:var(--primary)">Playlist</h3>
            <p style="margin-bottom: 20px;">W√§hle deinen Spielmodus:</p>

            <div class="mode-grid">
                <div class="mode-card" onclick="setupGame('timeline')">
                    <i class="fas fa-stream" style="color:#3498db"></i>
                    <span>Timeline</span>
                    <span class="mode-desc">Ordne die Jahre</span>
                </div>
                <div class="mode-card" onclick="setupGame('quiz')">
                    <i class="fas fa-bolt" style="color:#f1c40f"></i>
                    <span>Highscore</span>
                    <span class="mode-desc">Schnelles Quiz</span>
                </div>
                <div class="mode-card" onclick="setupGame('hl')">
                    <i class="fas fa-arrows-alt-v" style="color:#e67e22"></i>
                    <span>High / Low</span>
                    <span class="mode-desc">√Ñlter oder Neuer?</span>
                </div>
                <div class="mode-card" onclick="setupGame('onesec')">
                    <i class="fas fa-stopwatch" style="color:#e74c3c"></i>
                    <span>1 Sekunde</span>
                    <span class="mode-desc">Erkennst du es?</span>
                </div>
                <div class="mode-card" onclick="setupGame('blur')">
                    <i class="fas fa-image" style="color:#9b59b6"></i>
                    <span>Cover Blur</span>
                    <span class="mode-desc">Scharfer Blick</span>
                </div>
                <div class="mode-card" onclick="setupGame('duel')">
                    <i class="fas fa-user-friends" style="color:#2ecc71"></i>
                    <span>Party Duell</span>
                    <span class="mode-desc">1 vs 1 (Lokal)</span>
                </div>
            </div>

            <button class="btn btn-secondary" onclick="showScreen('screen-search')">Zur√ºck</button>
        </div>

        <div id="screen-game" class="hidden">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; font-size:0.9rem;">
                <div id="game-info-left">Score: 0</div>
                <div id="game-info-right">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
            </div>

            <div id="game-content"></div>

            <audio id="audio-player"></audio>
        </div>

        <div id="loader" class="hidden modal-overlay"><div class="spinner"></div><p>Lade Musik...</p></div>

        <div id="game-over" class="hidden modal-overlay">
            <h1 id="go-title" style="font-size:2.5rem; margin-bottom:10px;">Game Over</h1>
            <p id="go-msg" style="font-size:1.1rem; margin:20px 0; max-width:80%; line-height:1.5;">...</p>
            <button class="btn btn-primary" onclick="location.reload()">Neues Spiel</button>
        </div>

    </div>

    <script>
        /* =========================================
           CORE SYSTEM & STATE
           ========================================= */
        const state = {
            playlistId: null,
            tracks: [],
            pool: [],
            currentTrack: null,
            nextTrack: null,
            isPlaying: false,
            mode: null,
            score: 0,
            lives: 3,
            startTime: 0,
            // Mode Specifics
            timeline: [],
            targetScore: 10,
            hlStreak: 0,
            secLevel: 1, // 1s, 2s, 4s for OneSec mode
            duelP1: null,
            duelP2: null
        };

        const els = {
            audio: document.getElementById('audio-player'),
            content: document.getElementById('game-content'),
            infoLeft: document.getElementById('game-info-left'),
            infoRight: document.getElementById('game-info-right')
        };

        // --- DEEZER API HELPER (JSONP) ---
        function fetchDeezer(url) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                const cb = 'dz_' + Math.round(Math.random() * 1000000);
                window[cb] = (d) => { delete window[cb]; document.body.removeChild(script); resolve(d); };
                script.src = url + (url.includes('?') ? '&' : '?') + 'output=jsonp&callback=' + cb;
                script.onerror = () => reject();
                document.body.appendChild(script);
            });
        }

        // --- SMART YEAR FIX (ISRC) ---
        function getYearFromISRC(isrc) {
            if (!isrc || isrc.length < 7) return null;
            const yy = parseInt(isrc.substring(5, 7));
            if (isNaN(yy)) return null;
            // Wenn YY > 26 (aktuelles Jahr + Puffer), dann 19xx, sonst 20xx
            return (yy > (new Date().getFullYear() % 100) + 1) ? 1900 + yy : 2000 + yy;
        }

        async function getSongDetails(track) {
            try {
                // Hole Album (f√ºr Release Date) und Track (f√ºr ISRC falls nicht vorhanden)
                const albPromise = fetchDeezer(`https://api.deezer.com/album/${track.album.id}`);
                const trackPromise = track.isrc ? Promise.resolve(track) : fetchDeezer(`https://api.deezer.com/track/${track.id}`);
                const [alb, tDetails] = await Promise.all([albPromise, trackPromise]);

                let year = parseInt(alb.release_date.split('-')[0]);
                const isrcYear = getYearFromISRC(tDetails.isrc);

                // Nimm das √§ltere Jahr (Fix f√ºr Remasters)
                if(isrcYear && isrcYear < year && isrcYear > 1900) year = isrcYear;
                if(isNaN(year) || year < 1900 || year > 2030) return null;

                return { ...track, year, cover: track.album.cover_xl, cover_med: track.album.cover_medium };
            } catch(e) { return null; }
        }

        async function getValidSong() {
            while(state.pool.length > 0) {
                const raw = state.pool.pop();
                const song = await getSongDetails(raw);
                if(song) return song;
            }
            return null;
        }

        // --- PLAYLIST SELECTION ---
        function showScreen(id) {
            document.querySelectorAll('.app-container > div').forEach(el => {
                if(!['loader', 'game-over'].includes(el.id)) el.classList.add('hidden');
            });
            document.getElementById(id).classList.remove('hidden');
        }

        async function searchPlaylists() {
            const q = document.getElementById('search-input').value;
            if(!q) return;
            document.getElementById('playlist-list').innerHTML = 'Suche...';
            try {
                const d = await fetchDeezer(`https://api.deezer.com/search/playlist?q=${encodeURIComponent(q)}`);
                document.getElementById('playlist-list').innerHTML = d.data.map(p =>
                    `<div class="playlist-item" onclick="selectPlaylist('${p.id}', '${p.title.replace(/'/g,"")}')">
                        <img src="${p.picture_medium}"><div class="playlist-info"><h4>${p.title}</h4><span>${p.nb_tracks} Songs</span></div>
                    </div>`).join('');
            } catch(e) { alert("Fehler bei Suche"); }
        }

        async function selectPlaylist(id, name) {
            document.getElementById('loader').classList.remove('hidden');
            try {
                const d = await fetchDeezer(`https://api.deezer.com/playlist/${id}/tracks?limit=500`);
                state.tracks = d.data.filter(t => t.preview && t.album);
                if(state.tracks.length < 15) throw new Error("Playlist zu klein (min. 15 Songs)");
                state.pool = [...state.tracks].sort(() => 0.5 - Math.random());
                document.getElementById('selected-playlist-name').innerText = name;
                document.getElementById('loader').classList.add('hidden');
                showScreen('screen-mode');
            } catch(e) {
                document.getElementById('loader').classList.add('hidden');
                alert(e.message);
            }
        }

        // --- AUDIO CONTROL ---
        function playAudio(url, loop=false) {
            els.audio.loop = loop;
            els.audio.src = url;
            els.audio.play().catch(e=>console.log("Autoplay blocked"));
            state.isPlaying = true;
            document.querySelectorAll('.vinyl').forEach(v => v.classList.add('spinning'));
        }
        function stopAudio() {
            els.audio.pause();
            state.isPlaying = false;
            document.querySelectorAll('.vinyl').forEach(v => v.classList.remove('spinning'));
        }

        // --- GAME ROUTER ---
        function setupGame(mode) {
            state.mode = mode;
            state.score = 0;
            state.lives = 3;
            showScreen('screen-game');

            if(mode === 'timeline') initTimeline();
            if(mode === 'quiz') initQuiz();
            if(mode === 'hl') initHL();
            if(mode === 'onesec') initOneSec();
            if(mode === 'blur') initBlur();
            if(mode === 'duel') initDuel();
        }

        /* =========================================
           MODE 1: TIMELINE
           ========================================= */
        async function initTimeline() {
            state.timeline = [];
            state.targetScore = 10;
            updateHeader(`Ziel: ${state.targetScore}`, getHearts());

            document.getElementById('loader').classList.remove('hidden');
            const start = await getValidSong();
            state.timeline.push(start);
            nextTimeline();
        }

        async function nextTimeline() {
            const song = await getValidSong();
            if(!song) return endGame(true, "Playlist leer!");
            state.currentTrack = song;
            document.getElementById('loader').classList.add('hidden');

            renderTimelineUI();
            playAudio(song.preview, true);
        }

        function renderTimelineUI() {
            let html = `
                <div style="display:flex; align-items:center; gap:15px; margin-bottom:15px; background:rgba(0,0,0,0.2); padding:10px; border-radius:12px;">
                    <div class="vinyl-wrapper-sm" style="width:60px; height:60px; margin:0;"><div class="vinyl"><div class="vinyl-label" style="background-image:url(${state.currentTrack.cover_med})"></div></div></div>
                    <div style="text-align:left; font-size:0.9rem;"><strong>H√∂r mal rein...</strong><br>Wo geh√∂rt dieser Song hin?</div>
                    <button class="btn btn-primary" style="width:auto; margin:0;" onclick="togglePlayBtn(this)"><i class="fas fa-pause"></i></button>
                </div>
                <div class="timeline-container">
            `;

            html += `<div class="insert-btn" onclick="checkTimeline(0)">Hier einf√ºgen</div>`;
            state.timeline.forEach((s, i) => {
                html += `
                    <div class="timeline-card">
                        <div style="font-weight:800; color:var(--primary); font-size:1.2rem; min-width:50px;">${s.year}</div>
                        <img src="${s.cover_med}" style="width:40px; height:40px; border-radius:6px;">
                        <div style="text-align:left; font-size:0.8rem; line-height:1.2;"><strong>${s.title}</strong><br>${s.artist.name}</div>
                    </div>
                    <div class="insert-btn" onclick="checkTimeline(${i+1})">Hier einf√ºgen</div>
                `;
            });
            html += `</div>`;
            els.content.innerHTML = html;
        }

        function checkTimeline(index) {
            const y = state.currentTrack.year;
            const prev = state.timeline[index-1];
            const next = state.timeline[index];
            const errorPrev = prev && y < prev.year;
            const errorNext = next && y > next.year;

            if(errorPrev || errorNext) {
                state.lives--;
                updateHeader(`Ziel: ${state.targetScore}`, getHearts());
                alert(`Falsch! Es war ${y}.`);
                if(state.lives <= 0) endGame(false, "Keine Leben mehr.");
                else {
                    document.getElementById('loader').classList.remove('hidden');
                    nextTimeline();
                }
            } else {
                state.timeline.splice(index, 0, state.currentTrack);
                if(state.timeline.length >= state.targetScore) endGame(true, "Timeline komplett!");
                else {
                    document.getElementById('loader').classList.remove('hidden');
                    nextTimeline();
                }
            }
        }

        /* =========================================
           MODE 2: HIGHSCORE QUIZ
           ========================================= */
        async function initQuiz() {
            updateHeader("Score: 0", "");
            nextQuiz();
        }

        async function nextQuiz() {
            document.getElementById('loader').classList.remove('hidden');
            const target = await getValidSong();
            if(!target) return endGame(true, `Score: ${state.score}`);

            // Decoys
            const decoys = [];
            while(decoys.length < 3) {
                const d = state.pool[Math.floor(Math.random() * state.pool.length)];
                if(d.id !== target.id && !decoys.find(x => x.id === d.id)) decoys.push(d);
            }
            state.currentTrack = target;

            const options = [target, ...decoys].sort(()=>0.5-Math.random());

            document.getElementById('loader').classList.add('hidden');

            let html = `
                <div class="timer-bar"><div class="timer-fill timer-anim" style="animation-duration:30s;"></div></div>
                <div class="vinyl-wrapper-sm"><div class="vinyl"><div class="vinyl-label" style="background:#333;"></div></div></div>
                <div class="mode-grid" style="margin-top:20px;">
                    ${options.map(o => `<button class="btn btn-secondary" style="height:70px; white-space:normal; font-size:0.85rem;" onclick="checkQuiz(this, ${o.id===target.id})">${o.title}</button>`).join('')}
                </div>
            `;
            els.content.innerHTML = html;
            playAudio(target.preview, true);
            state.startTime = Date.now();
        }

        function checkQuiz(btn, correct) {
            stopAudio();
            document.querySelector('.timer-fill').style.animationPlayState = 'paused';
            document.querySelector('.vinyl-label').style.backgroundImage = `url(${state.currentTrack.cover})`;

            if(correct) {
                const ms = Date.now() - state.startTime;
                const pts = Math.max(100, Math.floor(1000 - (ms/30)));
                state.score += pts;
                updateHeader(`Score: ${state.score}`, "");
                btn.className = "btn btn-success";
                showFloatingScore(pts);
                setTimeout(nextQuiz, 1500);
            } else {
                btn.className = "btn btn-danger";
                setTimeout(() => endGame(false, `Final Score: ${state.score}`), 1500);
            }
        }

        /* =========================================
           MODE 3: HIGHER OR LOWER
           ========================================= */
        async function initHL() {
            state.hlStreak = 0;
            state.lives = 3;
            updateHeader("Streak: 0", getHearts());

            document.getElementById('loader').classList.remove('hidden');
            state.currentTrack = await getValidSong(); // Reference
            nextHL();
        }

        async function nextHL() {
            state.nextTrack = await getValidSong(); // Challenger
            if(!state.nextTrack) return endGame(true, `Streak: ${state.hlStreak}`);

            document.getElementById('loader').classList.add('hidden');

            let html = `
                <div class="timeline-card" style="opacity:0.8; transform:scale(0.95); margin-bottom:20px;">
                    <div style="font-weight:800; font-size:1.2rem; color:var(--primary);">${state.currentTrack.year}</div>
                    <img src="${state.currentTrack.cover_med}" style="width:40px; height:40px; border-radius:4px;">
                    <div style="text-align:left; font-size:0.8rem;">${state.currentTrack.title}</div>
                </div>

                <p style="font-size:1.1rem; font-weight:bold; margin:20px 0;">Ist dieser Song...</p>

                <div class="vinyl-wrapper-sm"><div class="vinyl"><div class="vinyl-label" style="background:#333;"></div></div></div>

                <div style="display:flex; gap:15px; margin-top:20px;">
                    <button class="btn btn-warn" style="flex:1; height:60px;" onclick="checkHL('older')">√ÑLTER üîΩ</button>
                    <button class="btn btn-success" style="flex:1; height:60px;" onclick="checkHL('newer')">NEUER üîº</button>
                </div>
            `;
            els.content.innerHTML = html;
            playAudio(state.nextTrack.preview, true);
        }

        function checkHL(guess) {
            stopAudio();
            const ref = state.currentTrack.year;
            const target = state.nextTrack.year;
            document.querySelector('.vinyl-label').style.backgroundImage = `url(${state.nextTrack.cover})`;

            const isOlder = target < ref;
            const isNewer = target > ref;
            const isSame = target === ref; // Bonus win

            let win = (guess === 'older' && isOlder) || (guess === 'newer' && isNewer) || isSame;

            if(win) {
                state.hlStreak++;
                updateHeader(`Streak: ${state.hlStreak}`, getHearts());
                alert(`Richtig! (${target})`);
                state.currentTrack = state.nextTrack; // Move up
                document.getElementById('loader').classList.remove('hidden');
                nextHL();
            } else {
                state.lives--;
                updateHeader(`Streak: ${state.hlStreak}`, getHearts());
                alert(`Falsch! Er war von ${target}.`);
                if(state.lives<=0) endGame(false, `Streak: ${state.hlStreak}`);
                else {
                    document.getElementById('loader').classList.remove('hidden');
                    nextHL();
                }
            }
        }

        /* =========================================
           MODE 4: 1-SECOND CHALLENGE
           ========================================= */
        async function initOneSec() {
            state.score = 0;
            updateHeader(`Score: 0`, "üéµ");
            nextOneSec();
        }

        async function nextOneSec() {
            document.getElementById('loader').classList.remove('hidden');
            const target = await getValidSong();
            if(!target) return endGame(true, `Score: ${state.score}`);

            // Decoys
            const decoys = [];
            while(decoys.length < 3) {
                const d = state.pool[Math.floor(Math.random() * state.pool.length)];
                if(d.id !== target.id && !decoys.find(x => x.id === d.id)) decoys.push(d);
            }
            state.currentTrack = target;
            state.secLevel = 1; // Start with 1 sec cost

            document.getElementById('loader').classList.add('hidden');

            let html = `
                <div class="vinyl-wrapper-sm"><div class="vinyl"><div class="vinyl-label" style="background:#333;"></div></div></div>
                <div style="display:flex; gap:10px; justify-content:center; margin:20px 0;">
                    <button class="btn btn-primary" onclick="playSnippet(1000)">1 Sekunde h√∂ren</button>
                    <button class="btn btn-warn" onclick="playSnippet(3000); state.secLevel=3;">+3s (-500 Pkt)</button>
                </div>
                <div class="mode-grid">
                    ${[target, ...decoys].sort(()=>0.5-Math.random()).map(o =>
                        `<button class="btn btn-secondary" style="height:70px; font-size:0.85rem;" onclick="checkOneSec(this, ${o.id===target.id})">${o.title}</button>`
                    ).join('')}
                </div>
            `;
            els.content.innerHTML = html;
            playSnippet(1000); // Auto start 1s
        }

        function playSnippet(ms) {
            stopAudio();
            els.audio.src = state.currentTrack.preview;
            els.audio.currentTime = 0;
            els.audio.play();
            document.querySelectorAll('.vinyl').forEach(v => v.classList.add('spinning'));
            setTimeout(() => stopAudio(), ms);
        }

        function checkOneSec(btn, correct) {
            stopAudio();
            document.querySelector('.vinyl-label').style.backgroundImage = `url(${state.currentTrack.cover})`;

            if(correct) {
                let pts = state.secLevel === 1 ? 1000 : 500;
                state.score += pts;
                updateHeader(`Score: ${state.score}`, "üéµ");
                btn.className = "btn btn-success";
                showFloatingScore(pts);
                setTimeout(nextOneSec, 1500);
            } else {
                btn.className = "btn btn-danger";
                setTimeout(() => endGame(false, `Score: ${state.score}`), 1500);
            }
        }

        /* =========================================
           MODE 5: COVER BLUR
           ========================================= */
        async function initBlur() {
            state.score = 0;
            updateHeader("Score: 0", "üñºÔ∏è");
            nextBlur();
        }

        async function nextBlur() {
            document.getElementById('loader').classList.remove('hidden');
            const target = await getValidSong();

            // Decoys (Artists this time)
            const decoys = [];
            while(decoys.length < 3) {
                const d = state.pool[Math.floor(Math.random() * state.pool.length)];
                if(d.id !== target.id && !decoys.find(x => x.id === d.id)) decoys.push(d);
            }
            state.currentTrack = target;

            document.getElementById('loader').classList.add('hidden');

            let html = `
                <div class="blur-container">
                    <img src="${target.cover}" class="blur-img unblur-anim">
                </div>
                <p>Wer ist das?</p>
                <div class="mode-grid">
                    ${[target, ...decoys].sort(()=>0.5-Math.random()).map(o =>
                        `<button class="btn btn-secondary" style="height:60px;" onclick="checkBlur(this, ${o.id===target.id})">${o.artist.name}</button>`
                    ).join('')}
                </div>
            `;
            els.content.innerHTML = html;
            playAudio(target.preview, true);
            state.startTime = Date.now();
        }

        function checkBlur(btn, correct) {
            stopAudio();
            // Stop animation by setting blur to 0 immediately via class replacement
            document.querySelector('.blur-img').style.filter = 'blur(0px)';

            if(correct) {
                const ms = Date.now() - state.startTime;
                // 20s animation. Max score 1000.
                let pts = Math.max(100, Math.floor(1000 - (ms/20)));
                state.score += pts;
                updateHeader(`Score: ${state.score}`, "üñºÔ∏è");
                btn.className = "btn btn-success";
                showFloatingScore(pts);
                setTimeout(nextBlur, 2000);
            } else {
                btn.className = "btn btn-danger";
                setTimeout(() => endGame(false, `Score: ${state.score}`), 2000);
            }
        }

        /* =========================================
           MODE 6: PARTY DUEL (1 vs 1)
           ========================================= */
        async function initDuel() {
            state.score = { p1: 0, p2: 0 };
            updateHeader("P1: 0", "P2: 0");
            nextDuelRound();
        }

        async function nextDuelRound() {
            document.getElementById('loader').classList.remove('hidden');
            state.currentTrack = await getValidSong();
            document.getElementById('loader').classList.add('hidden');

            let html = `
                <div class="vinyl-wrapper-sm"><div class="vinyl"><div class="vinyl-label" style="background:#333;"></div></div></div>
                <button class="btn btn-primary" onclick="playAudio('${state.currentTrack.preview}', true)">Audio Starten</button>
                <hr style="border:0; border-top:1px solid rgba(255,255,255,0.2); margin:15px 0;">

                <div style="text-align:left; margin-bottom:10px;">Spieler 1 Tipp:</div>
                <input type="number" id="p1-input" placeholder="Jahr..." style="margin-bottom:20px;">

                <div style="text-align:left; margin-bottom:10px;">Spieler 2 Tipp:</div>
                <input type="number" id="p2-input" placeholder="Jahr...">

                <button class="btn btn-success" style="margin-top:20px;" onclick="resolveDuel()">Aufl√∂sen</button>
            `;
            els.content.innerHTML = html;
        }

        function resolveDuel() {
            const p1 = parseInt(document.getElementById('p1-input').value);
            const p2 = parseInt(document.getElementById('p2-input').value);

            if(!p1 || !p2) return alert("Beide m√ºssen tippen!");

            stopAudio();
            const real = state.currentTrack.year;
            document.querySelector('.vinyl-label').style.backgroundImage = `url(${state.currentTrack.cover})`;

            const diff1 = Math.abs(real - p1);
            const diff2 = Math.abs(real - p2);

            let msg = `Jahr: ${real}\n`;
            if(diff1 < diff2) { state.score.p1++; msg += "Punkt f√ºr Spieler 1!"; }
            else if(diff2 < diff1) { state.score.p2++; msg += "Punkt f√ºr Spieler 2!"; }
            else { msg += "Unentschieden!"; }

            alert(msg);
            updateHeader(`P1: ${state.score.p1}`, `P2: ${state.score.p2}`);
            nextDuelRound();
        }

        /* =========================================
           GLOBAL HELPERS
           ========================================= */
        function togglePlayBtn(btn) {
            if(state.isPlaying) {
                stopAudio();
                btn.innerHTML = '<i class="fas fa-play"></i>';
            } else {
                playAudio(state.currentTrack.preview, true);
                btn.innerHTML = '<i class="fas fa-pause"></i>';
            }
        }

        function updateHeader(left, right) {
            els.infoLeft.innerText = left;
            els.infoRight.innerText = right;
        }

        function getHearts() {
            return "‚ù§Ô∏è".repeat(state.lives) + "üñ§".repeat(3-state.lives);
        }

        function showFloatingScore(pts) {
            const el = document.createElement('div');
            el.className = 'score-float';
            el.innerText = `+${pts}`;
            document.body.appendChild(el);
            setTimeout(()=>el.remove(), 1000);
        }

        function endGame(win, msg) {
            stopAudio();
            document.getElementById('go-title').innerText = win ? "Sieg!" : "Game Over";
            document.getElementById('go-msg').innerText = msg;
            document.getElementById('game-over').classList.remove('hidden');
        }

    </script>
</body>
</html>
